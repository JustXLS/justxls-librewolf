--- a/configure.in	2011-07-01 19:40:13.000000000 +0300
+++ b/configure.in	2011-09-15 21:10:22.000000000 +0300
@@ -109,8 +109,17 @@
     ],[AC_MSG_WARN([iceape-plugin not found, trying another])])
 fi
 
+if test "$GECKO_CFLAGS" = ""; then
+PKG_CHECK_MODULES(GECKO, [npapi-sdk],[ AC_MSG_NOTICE([Using npapi-sdk])
+    AC_DEFINE([HAVE_NEW_XULRUNNER],[1],[Define to 1 if using libxul 1.9.2 or higher])
+    ],[AC_MSG_ERROR([npapi-sdk not found, all out ot tries])])
+fi
+    
+
 PKG_CHECK_MODULES(NSPR, [nspr],[
     libdir=`$PKG_CONFIG --variable=libdir nspr`
+    GECKO_CFLAGS="$GECKO_CFLAGS $NSPR_CFLAGS"
+    AC_DEFINE([HAVE_NSPR],[1],[Define to 1 if using nspr])
     AC_SUBST(libdir)
    ],[AC_MSG_WARN([nspr not found, may not be needed])])
 
--- a/src/plugin.cpp	2011-11-29 14:20:21.000000000 -0500
+++ b/src/plugin.cpp	2011-11-29 14:22:52.000000000 -0500
@@ -42,10 +42,14 @@
 #include "plugin_setup.h"
 #include "plugin_types.h"
 #include "plugin_dbus.h"
+#ifdef HAVE_NSPR
+#include <nspr/nspr.h>
+#else
 #include <nsIPrefBranch.h>
 #include <nsIPrefService.h>
 #include <nsIServiceManager.h>
 #include <nsISupportsPrimitives.h>
+#endif
 #include <dlfcn.h>
 
 static NPObject *sWindowObj;

